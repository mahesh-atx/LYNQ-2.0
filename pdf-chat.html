<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with PDF â€” LYNQ AI</title>

    <script
      src="https://kit.fontawesome.com/ae8ff12b97.js"
      crossorigin="anonymous"
    ></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      // Required by PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
    </script>

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="./home/home.css">
    <style>
      #pdf-chat-view {
        display: flex;
        flex-direction: column;
        height: 100%; /* Make sure view-section fills height */
        overflow: hidden; /* Prevent double scrollbars */
      }

      /* --- NEW: Wrapper styles from home.css --- */
      #chat-wrapper {
        flex: 1; /* Takes up remaining space */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }
      #chat-container {
        flex: 1; /* Takes up space between status bar and input */
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
      }
      /* --- END NEW --- */
      
      #pdf-messages-wrapper {
        /* --- MODIFIED: Simplified to just be the list --- */
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        /* --- REMOVED ---
        flex: 1;
        overflow-y: auto;
        max-width: 900px;
        margin: 0 auto;
        */
      }
      
      #pdf-attachment-bar {
        padding: 12px 24px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-primary);
        font-size: 0.9rem;
        color: var(--text-secondary);
        display: none; /* Hidden by default */
        justify-content: space-between;
        align-items: center;
        animation: fadeIn 0.3s ease;
        flex-shrink: 0; /* --- ADDED: Prevents shrinking --- */
      }
      #pdf-attachment-bar .file-name {
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      #pdf-attachment-bar .file-status {
        font-style: italic;
      }

      .input-area-wrapper {
        padding: 1.5rem;
        border-top: 1px solid var(--border-primary);
        background: var(--bg-primary);
        width: 100%;
        flex-shrink: 0; /* --- ADDED: Prevents shrinking --- */
        /* --- REMOVED margin-top: auto; --- */
      }
      .input-container {
        position: relative;
        background: var(--bg-secondary);
        border: 1px solid var(--border-secondary);
        border-radius: 28px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
      }
      body.dark-mode .input-container {
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      #pdf-chat-input {
        width: 100%;
        background: transparent;
        border: none;
        resize: none;
        padding: 14px 20px;
        font-size: 1rem;
        color: var(--text-primary);
        min-height: 54px;
        padding-right: 20px;
        padding-bottom: 0;
        line-height: 1.5;
        font-family: "Outfit", sans-serif;
      }
      #pdf-chat-input:focus {
        outline: none;
      }

      .input-toolbar {
        position: static;
        padding: 0 10px 10px 10px;
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .toolbar-left, .toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .tool-btn-round {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        transition: 0.2s;
      }
      .tool-btn-round:hover {
        background: var(--border-primary);
        color: var(--text-primary);
      }
      .tool-btn-round.send-btn {
        background: var(--text-heading);
        color: var(--bg-primary);
      }
      .tool-btn-round.send-btn:hover {
        opacity: 0.8;
      }
      .tool-btn-round.send-btn:disabled {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        cursor: not-allowed;
        opacity: 0.7;
      }

      #pdf-send-btn {
        position: static;
        transform: none;
      }

      .pdf-message {
        display: flex;
        gap: 12px;
        /* --- MODIFIED: Centered like index.html --- */
        max-width: 900px;
        width: 100%;
      }
      .pdf-message .avatar {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
        flex-shrink: 0;
      }
      .pdf-message .bubble {
        padding: 12px 16px;
        border-radius: 12px;
        line-height: 1.5;
        white-space: pre-wrap;
        max-width: 90%; /* Prevent bubble from being 100% wide */
      }
      .pdf-message.user {
        align-self: flex-end;
        justify-content: flex-end; /* --- ADDED: Pushes bubble right --- */
      }
      .pdf-message.user .bubble {
        background: var(--brand-primary);
        color: white;
        border-bottom-right-radius: 4px;
      }
      .pdf-message.ai {
        align-self: flex-start;
      }
      .pdf-message.ai .bubble {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-bottom-left-radius: 4px;
      }

      /* --- ADDED: Center messages in the list --- */
      #pdf-messages-wrapper .pdf-message {
        margin-left: auto;
        margin-right: auto;
      }

    </style>
  </head>
  <body>
    <div id="app-container">
      <aside id="sidebar">
        <div style="flex-shrink: 0">
          <div class="sidebar-header">
            <span style="display: flex; align-items: center; gap: 10px"
              ><i class="fa-solid fa-bolt"></i> LYNQ AI</span
            >
            <button class="action-btn mobile-only" onclick="toggleSidebar()">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        </div>
        <nav class="nav-menu">
          <div class="nav-label">Menu</div>
          <a href="index.html" class="nav-item" id="nav-new-chat"
            ><i class="fa-solid fa-plus"></i> New Chat</a
          >
          <a href="index.html" class="nav-item" id="nav-home"
            ><i class="fa-solid fa-house"></i> Home</a
          >
          <a href="plugins.html" class="nav-item" id="nav-plugins"
            ><i class="fa-solid fa-plug"></i> Plugins</a
          >
          <a href="projects.html" class="nav-item" id="nav-projects"
            ><i class="fa-solid fa-layer-group"></i> Projects</a
          >
          <div
            class="nav-label"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding-right: 5px;
              position: relative;
            "
          >
            <span id="recent-chats-label">Recent Chats</span>
            <input
              type="text"
              id="chat-search-input"
              placeholder="Search chats..."
              style="
                display: none;
                width: 100%;
                background: var(--bg-primary);
                border: 1px solid var(--border-primary);
                border-radius: 6px;
                padding: 4px 8px;
                color: var(--text-primary);
              "
              onkeyup="filterRecentChats()"
              onblur="toggleChatSearch(false)"
            />
            <i
              class="fa-solid fa-magnifying-glass search-trigger"
              id="chat-search-trigger"
              onclick="toggleChatSearch(true)"
            ></i>
          </div>
          <div id="recent-chats-container"></div>
        </nav>
        <div class="sidebar-footer">
          <a href="settings.html" class="nav-item" id="nav-settings"
            ><i class="fa-solid fa-gear"></i> Settings</a
          >
          <a
            href="profile.html"
            class="nav-item"
            id="nav-profile"
            style="margin-top: 5px"
          >
            <div
              class="avatar user"
              style="
                width: 24px;
                height: 24px;
                font-size: 0.7rem;
                margin-right: 0;
              "
            >
              MD
            </div>
            Mahesh Dongare
          </a>
        </div>
      </aside>

      <main id="main-content">
        <div class="top-bar">
          <button class="action-btn" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div style="flex: 1"></div>
          <div class="top-actions">
            <button class="upgrade-btn" onclick="togglePricing()">
              <i class="fa-regular fa-gem"></i> <span>Upgrade to Pro</span>
            </button>
            <button class="top-profile-btn" onclick="location.href='profile.html'">
              <div class="avatar user">MD</div>
              <span>Mahesh</span>
            </button>
          </div>
        </div>

        <div id="pdf-chat-view" class="view-section active">
          
          <div id="pdf-attachment-bar">
            </div>

          <div id="chat-wrapper">
            
            <div id="chat-container">
              
              <div id="pdf-messages-wrapper">
                <div class="pdf-message ai">
                  <div class="avatar ai"><i class="fa-solid fa-bolt"></i></div>
                  <div class="bubble">
                    Hello! Please upload a PDF using the
                    <i class="fa-solid fa-plus"></i> button below to begin.
                  </div>
                </div>
              </div>

            </div>
            
            <div class="input-area-wrapper">
              <input
                type="file"
                id="pdf-upload"
                accept="application/pdf"
                style="display: none"
              />

              <div class="input-container">
                <textarea
                  id="pdf-chat-input"
                  rows="1"
                  placeholder="Ask a question about your PDF..."
                  disabled
                ></textarea>
                <div class="input-toolbar">
                  <div class="toolbar-left">
                    <button
                      class="tool-btn-round"
                      id="pdf-upload-btn"
                      title="Upload PDF"
                    >
                      <i class="fa-solid fa-plus"></i>
                    </button>
                    <div class="model-selector-wrapper">
                      <button
                        class="model-btn"
                        onclick="toggleModelDropdown()"
                        id="current-model-btn"
                      >
                        <i class="fa-solid fa-bolt" style="color: #ffd700"></i>
                        1.5 Pro
                        <i class="fa-solid fa-chevron-down chevron"></i>
                      </button>
                      <div class="model-dropdown" id="model-dropdown">
                        <div
                          class="model-option selected"
                          onclick="selectModel(this, 'llama3-8b-8192', 'fa-bolt', '#FFD700')"
                        >
                          <span
                            ><i
                              class="fa-solid fa-bolt"
                              style="color: #ffd700; margin-right: 8px"
                            ></i>
                            Gemini 1.5 Pro</span
                          >
                          <span class="pro-badge">Pro</span>
                          <i class="fa-solid fa-check check-icon"></i>
                        </div>
                        <div
                          class="model-option"
                          onclick="selectModel(this, 'gemma-70b-it', 'fa-robot', '#10a37f')"
                        >
                          <span
                            ><i
                              class="fa-solid fa-robot"
                              style="color: #10a37f; margin-right: 8px"
                            ></i>
                            GPT-4o</span
                          >
                          <span class="pro-badge">Pro</span>
                          <i
                            class="fa-solid fa-check check-icon"
                            style="display: none"
                          ></i>
                        </div>
                        <div
                          class="model-option"
                          onclick="selectModel(this, 'llama3-70b-8192', 'fa-bolt-lightning', '#FF4500')"
                        >
                          <span
                            ><i
                              class="fa-solid fa-bolt-lightning"
                              style="color: #ff4500; margin-right: 8px"
                            ></i>
                            Gemini Flash</span
                          >
                          <i
                            class="fa-solid fa-check check-icon"
                            style="display: none"
                          ></i>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="toolbar-right">
                    <button
                      class="tool-btn-round"
                      title="Voice Input (Coming Soon)"
                      disabled
                      style="cursor: not-allowed"
                    >
                      <i class="fa-solid fa-microphone-lines"></i>
                    </button>
                    <button
                      class="tool-btn-round send-btn"
                      id="pdf-send-btn"
                      disabled
                    >
                      <i class="fa-solid fa-arrow-up"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div
                style="
                  text-align: center;
                  margin-top: 10px;
                  font-size: 0.75rem;
                  color: var(--text-secondary);
                  opacity: 0.7;
                "
              >
                LYNQ AI can make mistakes. Check important info.
              </div>
            </div>

          </div>
        </div>
      </main>
    </div>

    <div id="toast">
      <i class="fa-solid fa-circle-check"></i> Link copied to clipboard!
    </div>
    <div class="modal-overlay" id="pricing-modal">
        <div class="pricing-modal">
            </div>
    </div>

    <script src="script.js"></script>

    <script>
      const uploadInput = document.getElementById("pdf-upload");
      const uploadButton = document.getElementById("pdf-upload-btn");
      const attachmentBar = document.getElementById("pdf-attachment-bar");
      // --- MODIFIED: Get the new chat-container for scrolling ---
      const chatContainer = document.getElementById("chat-container");
      const messagesWrapper = document.getElementById("pdf-messages-wrapper");
      const chatInput = document.getElementById("pdf-chat-input");
      const sendButton = document.getElementById("pdf-send-btn");

      let pdfText = "";
      let chatHistory = [];

      uploadButton.addEventListener("click", () => {
        uploadInput.click();
      });

      uploadInput.addEventListener("change", async (event) => {
        const file = event.target.files[0];
        if (!file || file.type !== "application/pdf") {
          showToast("Please select a PDF file.");
          return;
        }

        attachmentBar.style.display = "flex";
        attachmentBar.innerHTML = `
          <span class="file-name"><i class="fa-solid fa-spinner fa-spin"></i> Processing "${file.name}"...</span>
          <span class="file-status">Extracting text...</span>
        `;
        
        pdfText = "";
        chatInput.disabled = true;
        sendButton.disabled = true;

        try {
          const fileReader = new FileReader();
          fileReader.onload = async function () {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              pdfText += textContent.items.map((item) => item.str).join(" ") + "\\n";
            }
            
            attachmentBar.innerHTML = `
              <span class="file-name"><i class="fa-solid fa-file-pdf"></i> ${file.name}</span>
              <span class="file-status">(${pdf.numPages} pages) Ready to chat!</span>
            `;

            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
            
            // Auto-send first message
            addMessage("Please summarize this document briefly.", "user");
            handleSend(true); // Pass a flag to indicate this is the auto-send
          };
          fileReader.readAsArrayBuffer(file);
        } catch (error) {
          console.error("Error parsing PDF:", error);
          attachmentBar.innerHTML = `
            <span class="file-name" style="color: var(--text-danger);"><i class="fa-solid fa-circle-exclamation"></i> Error loading PDF.</span>
          `;
          showToast("Failed to process PDF.");
        }
      });

      // --- MODIFIED: Accept an optional query override ---
      const handleSend = async (isAutoSend = false) => {
        const query = isAutoSend ? "Please summarize this document briefly." : chatInput.value.trim();
        
        if (!query) return;

        if (!pdfText) {
            showToast("Please upload a PDF before asking questions.");
            return;
        }

        // Only clear input if it was a manual send
        if (!isAutoSend) {
          chatInput.value = "";
          chatInput.style.height = "auto";
        }
        
        // Don't add the user message to UI if it's the auto-send
        // (it was already added before calling)
        if (!isAutoSend) {
          addMessage(query, "user");
        }
        
        chatHistory.push({ role: "user", content: query });

        const thinkingMessage = addMessage("...", "ai");
        
        const systemMessage = `You are a helpful assistant. The user has provided the following PDF document text. Answer the user's questions based *only* on this text. Do not use any outside knowledge.
        
---PDF CONTENT---
${pdfText}
---END CONTENT---
`;

        try {
            // Using the global getApiResponse from script.js
            const response = await getApiResponse(query, systemMessage, chatHistory);
            
            thinkingMessage.querySelector(".bubble").innerText = response;
            chatHistory.push({ role: "ai", content: response });
        } catch (error) {
            console.error("Error in handleSend:", error);
            thinkingMessage.querySelector(".bubble").innerText = "Error: " + error.message;
            // You might want to add an 'error' class for styling
            // thinkingMessage.querySelector(".bubble").classList.add("error");
        }
      };

      sendButton.addEventListener("click", () => handleSend(false));
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleSend(false);
        }
      });

      function addMessage(content, role) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `pdf-message ${role}`;
        
        const avatar = document.createElement("div");
        avatar.className = `avatar ${role}`;
        avatar.innerHTML = role === "user" ? "MD" : '<i class="fa-solid fa-bolt"></i>';
        
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.innerText = content;
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        messagesWrapper.appendChild(messageDiv);
        
        // --- MODIFIED: Scroll the new container ---
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return messageDiv;
      }

      chatInput.addEventListener('input', () => {
          chatInput.style.height = 'auto';
          chatInput.style.height = (chatInput.scrollHeight) + 'px';
      });

    </script>
  </body>
</html>