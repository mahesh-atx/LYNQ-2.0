<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login / Sign Up — LYNQ AI</title>
    <script
      src="https://kit.fontawesome.com/ae8ff12b97.js"
      crossorigin="anonymous"
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        /* Prevent flash of wrong theme on body */
        background-color: var(--bg-primary);
        transition: background-color 0.3s ease;
      }
      /* Initial body state matching dark mode to reduce flicker if default is dark */
      body.dark-mode {
        background-color: #121212;
      }
      
      #login-view {
        flex: 1;
        display: flex; /* Will be managed by JS */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: var(--bg-primary);
        padding: 20px;
      }
      
      /* Centered Loader */
      #auth-loader {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: var(--bg-primary);
        z-index: 9999;
      }
      
      .login-container {
        max-width: 420px;
        width: 100%;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 30px;
        padding: 40px;
        text-align: center;
        box-shadow: var(--shadow-soft);
        animation: fadeUp 0.4s ease;
      }
      .login-header {
        margin-bottom: 30px;
      }
      .login-header h1 {
        font-size: 2.5rem;
        color: var(--text-heading);
        margin-bottom: 10px;
      }
      .login-header p {
        color: var(--text-secondary);
      }
      .provider-buttons {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }
      .provider-btn {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border-primary);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 500;
        font-size: 0.95rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .provider-btn:hover {
        background: var(--bg-primary);
        border-color: var(--border-secondary);
      }
      .provider-btn i {
        font-size: 1.2rem;
      }
      .divider {
        font-size: 0.8rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      .divider::before,
      .divider::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--border-primary);
      }
      .login-form {
        display: grid;
        gap: 15px;
        text-align: left;
      }
      .login-form label {
        color: var(--text-heading);
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 5px;
        display: block;
      }
      .login-form input {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border-primary);
        background: var(--bg-primary);
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.2s;
      }
      .login-form input:focus {
        border-color: var(--text-heading);
      }
      .login-btn {
        margin-top: 10px;
        width: 100%;
        padding: 14px;
        background: var(--bg-accent);
        color: var(--text-accent);
        border-radius: 15px;
        border: none;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.2s;
      }
      .login-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .toggle-link {
        margin-top: 25px;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }
      .toggle-link a {
        color: var(--text-heading);
        font-weight: 600;
        text-decoration: none;
        transition: color 0.2s;
      }
      .toggle-link a:hover {
        color: var(--bg-accent);
      }
      .phone-group {
        display: none; /* Hidden by default */
        gap: 10px;
      }
      .phone-group input {
        flex: 1;
      }
      .phone-group button {
        padding: 0 20px;
        border-radius: 12px;
        border: 1px solid var(--border-primary);
        background: var(--bg-primary);
        color: var(--text-primary);
        cursor: pointer;
      }
      #email-group {
        display: grid;
        gap: 15px;
      }
      #error-message {
        color: var(--text-danger);
        background: var(--bg-danger);
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
        display: none; /* Hidden by default */
        text-align: center;
        margin-top: 10px;
      }
      #recaptcha-container {
        margin-top: 15px;
        display: flex;
        justify-content: center;
      }
    </style>
  </head>
  <body class="dark-mode">
    <script>
      (function() {
        const savedTheme = localStorage.getItem("lynq-theme");
        if (savedTheme === "light") {
          document.body.classList.remove("dark-mode");
        }
      })();
    </script>

    <div id="auth-loader">
      <div class="loading-spinner"></div>
      <p style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9rem;">checking authentication...</p>
    </div>

    <div id="login-view" style="display: none;">
      <div class="login-container">
        <div class="login-header">
          <span
            style="
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 10px;
              color: var(--text-heading);
              margin-bottom: 10px;
            "
          >
            <i class="fa-solid fa-bolt"></i> LYNQ AI
          </span>
          <h1 id="form-title">Welcome Back</h1>
          <p id="form-subtitle">Log in to continue your work.</p>
        </div>

        <div class="provider-buttons">
          <button class="provider-btn" id="google-signin">
            <i class="fa-brands fa-google"></i> Sign in with Google
          </button>
          <button class="provider-btn" id="github-signin">
            <i class="fa-brands fa-github"></i> Sign in with GitHub
          </button>
          <button class="provider-btn" id="phone-signin-toggle">
            <i class="fa-solid fa-phone"></i> Sign in with Phone
          </button>
        </div>

        <div class="divider">OR</div>

        <form class="login-form" id="login-form">
          <div id="email-group">
            <div id="confirm-name-div" style="display: none">
              <label for="name">Full Name</label>
              <input type="text" id="name" placeholder="Mahesh Dongare" />
            </div>
            <div>
              <label for="email">Email Address</label>
              <input
                type="email"
                id="email"
                placeholder="you@example.com"
                required
              />
            </div>
            <div>
              <label for="password">Password</label>
              <input
                type="password"
                id="password"
                placeholder="••••••••"
                required
              />
            </div>
          </div>

          <div class="phone-group" id="phone-group">
            <input type="tel" id="phone-number" placeholder="+1 555-555-1234" />
            <button type="button" id="send-code-btn">Send Code</button>
          </div>

          <div class="phone-group" id="code-group">
            <input
              type="text"
              id="verification-code"
              placeholder="Enter 6-digit code"
            />
          </div>

          <div id="recaptcha-container"></div>

          <div id="error-message"></div>

          <button type="submit" class="login-btn" id="submit-btn">
            Log In
          </button>
        </form>

        <p class="toggle-link">
          Don't have an account?
          <a href="#" id="toggle-form-link">Sign Up</a>
        </p>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <script src="auth.js"></script>

    <script>
      let isLogin = true;
      let authMode = "email";

      const authLoader = document.getElementById("auth-loader");
      const loginView = document.getElementById("login-view");

      const form = document.getElementById("login-form");
      const submitBtn = document.getElementById("submit-btn");
      const formTitle = document.getElementById("form-title");
      const subtitle = document.getElementById("form-subtitle");
      const toggleLink = document.getElementById("toggle-form-link");
      const nameDiv = document.getElementById("confirm-name-div");

      const emailGroup = document.getElementById("email-group");
      const phoneGroup = document.getElementById("phone-group");
      const codeGroup = document.getElementById("code-group");
      const phoneToggleBtn = document.getElementById("phone-signin-toggle");
      const sendCodeBtn = document.getElementById("send-code-btn");

      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const nameInput = document.getElementById("name");
      const phoneInput = document.getElementById("phone-number");
      const codeInput = document.getElementById("verification-code");

      const googleBtn = document.getElementById("google-signin");
      const githubBtn = document.getElementById("github-signin");
      const errorMessage = document.getElementById("error-message");

      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyCdWjeOCLGTbW95_7Omn-aijRVMww8hdqk",
        authDomain: "lynq-ai-20666.firebaseapp.com",
        projectId: "lynq-ai-20666",
        storageBucket: "lynq-ai-20666.firebasestorage.app",
        messagingSenderId: "278937715698",
        appId: "1:278937715698:web:4c913d5651cab6637be16b",
        measurementId: "G-TGT7C31BDF",
      };

      initializeFirebase(firebaseConfig);
      setupRecaptcha("recaptcha-container");

      // --- AUTH STATE LISTENER FOR LOADING SCREEN ---
      // auth.js provides a listener mechanism, but we can also hook into firebase directly here
      // to ensure we don't show the login form if the user is already logged in.
      
      // Listen for the custom event dispatched by auth.js
      document.addEventListener("authStateReady", (e) => {
        const user = e.detail.user;
        if (user) {
           // User is logged in. auth.js will handle redirect.
           // Keep showing loader or update text.
           if(authLoader) authLoader.innerHTML = '<div class="loading-spinner"></div><p style="margin-top:15px;">Redirecting...</p>';
        } else {
           // User is NOT logged in. Show the form.
           if(authLoader) authLoader.style.display = "none";
           if(loginView) loginView.style.display = "flex";
        }
      });

      function showError(message) {
        errorMessage.innerText = message;
        errorMessage.style.display = "block";
      }

      function hideError() {
        errorMessage.innerText = "";
        errorMessage.style.display = "none";
      }

      function toggleFormMode(event) {
        event?.preventDefault();
        isLogin = !isLogin;
        hideError();

        nameDiv.style.display = isLogin ? "none" : "block";
        formTitle.innerText = isLogin ? "Welcome Back" : "Create Account";
        subtitle.innerText = isLogin
          ? "Log in to continue your work."
          : "Create your new LYNQ AI account.";
        submitBtn.innerText = isLogin ? "Log In" : "Sign Up";
        toggleLink.innerHTML = isLogin
          ? `Don't have an account? <a href="#" id="toggle-form-link">Sign Up</a>`
          : `Already have an account? <a href="#" id="toggle-form-link">Log In</a>`;

        document
          .getElementById("toggle-form-link")
          .addEventListener("click", toggleFormMode);
      }

      function setAuthMode(mode) {
        authMode = mode;
        hideError();
        if (mode === "email") {
          emailGroup.style.display = "grid";
          phoneGroup.style.display = "none";
          codeGroup.style.display = "none";
          phoneToggleBtn.innerText = "Sign in with Phone";
          submitBtn.innerText = isLogin ? "Log In" : "Sign Up";
        } else if (mode === "phone") {
          emailGroup.style.display = "none";
          phoneGroup.style.display = "flex";
          codeGroup.style.display = "flex";
          phoneToggleBtn.innerText = "Sign in with Email";
          submitBtn.innerText = "Verify Code & Sign In";
        }
      }

      document
        .getElementById("toggle-form-link")
        .addEventListener("click", toggleFormMode);

      googleBtn.addEventListener("click", async () => {
        hideError();
        try {
          await signInWithGoogle();
        } catch (error) {
          showError(error.message);
        }
      });

      githubBtn.addEventListener("click", async () => {
        hideError();
        try {
          await signInWithGitHub();
        } catch (error) {
          showError(error.message);
        }
      });

      phoneToggleBtn.addEventListener("click", () => {
        setAuthMode(authMode === "email" ? "phone" : "email");
      });

      sendCodeBtn.addEventListener("click", async () => {
        hideError();
        const phoneNumber = phoneInput.value;
        if (!phoneNumber) {
          showError("Please enter a phone number.");
          return;
        }
        try {
          sendCodeBtn.disabled = true;
          sendCodeBtn.innerText = "Sending...";
          await signInWithPhone(phoneNumber);
          showError("Verification code sent! Check your phone.");
          sendCodeBtn.disabled = false;
          sendCodeBtn.innerText = "Resend Code";
        } catch (error) {
          showError(error.message);
          sendCodeBtn.disabled = false;
          sendCodeBtn.innerText = "Send Code";
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideError();
        submitBtn.disabled = true;
        submitBtn.innerText = "Processing...";

        try {
          if (authMode === "email") {
            const email = emailInput.value;
            const password = passwordInput.value;
            const name = nameInput.value;

            if (isLogin) {
              await logInWithEmail(email, password);
            } else {
              await signUpWithEmail(email, password, name);
            }
          } else if (authMode === "phone") {
            const code = codeInput.value;
            if (!code) throw new Error("Please enter the verification code.");
            await verifyPhoneCode(code);
          }
        } catch (error) {
          showError(error.message);
          submitBtn.disabled = false;
          if (authMode === "email") {
            submitBtn.innerText = isLogin ? "Log In" : "Sign Up";
          } else {
            submitBtn.innerText = "Verify Code & Sign In";
          }
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("action") === "signup") {
          isLogin = true;
          toggleFormMode(null);
        }
      });
    </script>
  </body>
</html>