# LYNQ Project Documentation

This document provides a comprehensive technical overview of the **LYNQ** project. It is designed to allow a developer to understand, replicate, and extend the current codebase.

## 1. Project Overview

**LYNQ** is an advanced AI chat interface that integrates multiple LLMs, web search capabilities, and a unique "Canvas" mode for code generation and document editing. It features a modular frontend built with Vanilla JavaScript and a robust Node.js backend handling RAG (Retrieval Augmented Generation), long-term memory, and external API integrations.

**Key Capabilities:**

- **Multi-Model Support:** Switch between Groq (Llama, Compound AI), OpenRouter models, and more via `config/models.json`.
- **Compound AI (Agentic):** `groq/compound` and `groq/compound-mini` models with built-in Web Search, Code Execution, Browser Automation, and Wolfram Alpha.
- **RAG & Memory:** Long-term memory using local vector storage and semantic search.
- **Web Search:** Real-time web search with "Source Authority" scoring, deep research scraping, and image/video carousels.
- **Hybrid Web Search:** For Compound models, combines Google Custom Search visuals (images/videos) with Compound's built-in real-time search for best results.
- **Canvas Mode:** A split-screen code editor (Monaco Editor) for viewing and editing AI-generated code/documents in real-time.
- **Data Analysis:** Client-side file processing (Excel/CSV) and chart generation.
- **Voice Mode:** Voice-to-text input.

---

## 2. Technical Stack

### Frontend

- **Core:** HTML5, CSS3, Vanilla JavaScript (ES6+ Modules).
- **Styling:** Custom Design System (`config/design-system.css`) with CSS Variables. No external CSS framework (like Tailwind) is used in the core; strictly custom CSS.
- **State Management:** Custom `store.js` for managing chat state and preferences.
- **Libraries:**
  - `firebase`: Authentication (Google Sign-In).
  - `monaco-editor`: Code editing (Lazy loaded via CDN).
  - `marked`: Markdown parsing.
  - `highlight.js`: Syntax highlighting.
  - `chart.js`: Data visualization.
  - `xlsx`: Spreadsheet parsing.
  - `jspdf` / `html2canvas`: PDF export.
  - `font-awesome` / `lucide`: Icons.

### Backend

- **Runtime:** Node.js.
- **Framework:** Express.js.
- **Database:**
  - **MongoDB:** Stores Chat History (`chats` collection) and User Profiles (`users` collection).
  - **Local JSON:** Stores Vector Embeddings (`data/vector_store.json`).
- **AI/ML:**
  - `@google/generative-ai`: For Embeddings (`text-embedding-004`) and Gemini Chat.
  - `node-fetch`: For API calls to Groq/OpenRouter.
  - `cheerio`: For web scraping.
- **Auth:** Firebase Admin SDK (Server-side token verification).

---

## 3. Frontend Architecture Details

The frontend is served statically from the `public/` directory but is architected as a Single Page Application (SPA) feel using Vanilla JS modules.

### File Structure (`public/`)

- `index.html`: Main entry point. Contains the app shell (Sidebar, Main Content, Canvas Pane).
- `css/`: Modular CSS files.
  - `design-system.css`: Global variables (colors, spacing, typography).
  - `style.css`: Base styles and components.
  - `home.css`: Chat interface specific styles.
  - `responsive.css`: Mobile breakpoints.
  - `animations.css`: Keyframe animations.
- `js/`: Modular JavaScript files.
  - `script.js`: Main initialization logic.
  - `components.js`: Injects reusable HTML (Sidebar, Topbar) into the DOM.
  - `chat.js`: Core chat logic (message handling, UI updates).
  - `canvas.js`: **Critical.** Manages the Monaco Editor and Preview Iframe.
  - `tools.js`: Handles the "Tools" dropdown implementation.
  - `api.js`: Centralized API interaction layer.
  - `store.js`: LocalStorage wrapper for settings/history.

### UI Features

- **Theming:** Dark/Light mode toggle handled by `theme.js`. Persisted in LocalStorage.
- **Responsiveness:**
  - **Mobile Action Sheet:** A bottom-sheet interface for mobile users (`mobile-action-sheet`) replacing the sidebar/tools menu on small screens.
  - **Swipe Gestures:** Model selector sheet on mobile supports swipe-to-close.
- **Canvas (Monaco Editor):**
  - **Lazy Loading:** Monaco is NOT bundled. It is loaded via CDN only when the user invokes "Canvas Mode" or code is generated. This optimizes initial load time.
  - **Custom Theme:** `lynq-dark` theme defined in `canvas.js` to match the app's aesthetic.
  - **Tabs:** "Code" tab (Editor) and "Preview" tab (Iframe).
  - **WYSIWYG:** For Markdown, edits in the Preview (contenteditable) are synced back to Monaco via `postMessage`.
  - **Streaming:** Code generated by AI is streamed character-by-character into the editor for a "typing" effect.

---

## 4. Backend Architecture Details (`server.js`)

The backend is a monolithic Express server that handles API requests and serves static files.

### RAG & Memory System

- **Vector Store:** A JSON file (`data/vector_store.json`) acting as a simple vector database.
- **Embeddings:** Uses Google's `text-embedding-004` model.
- **Logic:**
  1.  User message received.
  2.  `api/rag/search` (internal logic) embeds the message.
  3.  Calculates **Cosine Similarity** against stored vectors.
  4.  Retrieves top 3 relevant "memories".
  5.  Injects these memories into the System Prompt context window.
- **Negative Filtering:** A hardcoded list `NEGATIVE_MEMORY_PHRASES` prevents the system from memorizing useless info like "I don't know".

### Web Search System

- **Provider:** Google Custom Search JSON API.
- **Authority Scoring:**
  - The backend parses search results and assigns a score (0-100) based on the domain.
  - `.gov`, `.edu` = 100.
  - `github.com`, `stackoverflow.com` = 80.
  - Major News Sites = 70.
- **Deep Research:**
  - If enabled, the backend **scrapes** the full content of the top 3 textual results using `cheerio`.
  - It cleans the HTML (removes ads, navs) and feeds the raw text to the LLM.
- **Caching:** Results are cached in-memory (`Map`) for 5 minutes to save API quotas.
- **Image Carousels:** Extracts images from search results (via `pagemap.cse_image`) and YouTube video links for rich visual responses.
- **Inline Citations (Perplexity-style):**
  - Sources appear as clickable badges directly after each fact in the response
  - AI uses format `[[cite:Source Name:URL]]` which renders as styled badges
  - Colorful badges with different colors for variety (purple, pink, green, orange)
  - Clicking a badge opens the source URL in a new tab
- **Sources Panel (Collapsible):**
  - A collapsible UI panel below AI responses showing all sources
  - Displays source titles, URLs, and authority scores (0-100)
  - One-click "verify" button to open sources in new tab
  - Provides a summary view of all referenced sources

### Compound AI System (Agentic Models)

LYNQ supports Groq's **Compound AI** models which have built-in agentic capabilities:

- **Available Models:**

  - `groq/compound`: Supports multiple tool calls per request. Best for complex queries.
  - `groq/compound-mini`: Single tool call, 3x lower latency. Best for quick facts.

- **Built-in Tools (Automatic):**
  | Tool | Description |
  |------|-------------|
  | **Web Search** | Real-time internet search for current information |
  | **Code Execution** | Run Python code server-side to solve problems |
  | **Browser Automation** | Interact with web pages programmatically |
  | **Wolfram Alpha** | Complex calculations and scientific data queries |

- **Hybrid Web Search Approach:**

  - **Problem:** Groq's built-in web search returns text only (no images/videos).
  - **Solution:** When using Compound models with Web Search enabled:
    1. LYNQ runs Google Custom Search first to extract images/videos.
    2. These visuals are injected into the Compound model's context.
    3. Compound uses its own built-in search for real-time text data.
    4. Result: Best of both worlds - rich visuals + real-time accuracy.

- **Executed Tools Response:**
  - The API returns `executedTools` array showing which tools the model used.
  - Server logs: `ðŸ”§ Compound Tools Used: 1. web_search`

### API Endpoints

- **`GET /api/models`**: Returns list of available models from `config/models.json`.
- **`GET /api/chats`**: List user's chat history (titles/IDs).
- **`GET /api/chats/:id`**: Get full history of a specific chat.
- **`POST /api/chats/save`**: Save/Update chat history.
- **`POST /api/rag/add`**: Manually add an item to long-term memory.
- **`POST /api/users/sync`**: Sync Firebase user data to MongoDB.

---

## 5. Third-Party APIs

To build/run this project, you need the following API keys in your `.env` file:

1.  **Google Generative AI API Key** (`GOOGLE_GENERATIVE_AI_KEY`):
    - Used for: Embeddings (RAG) via `text-embedding-004` model.
2.  **Groq API Key** (`GROQ_API_KEY`):
    - Used for: Llama models and Compound AI (agentic models with built-in tools).
    - Required for: `groq/compound`, `groq/compound-mini`, `llama-3.3-70b-versatile`, etc.
3.  **OpenRouter API Key** (`OPENROUTER_API_KEY`) - Optional:
    - Used for: Access to additional models via OpenRouter (DeepSeek, Qwen, Mistral, etc.).
4.  **Google Custom Search API** (`GOOGLE_SEARCH_API_KEY` & `GOOGLE_SEARCH_ENGINE_ID`):
    - Used for: The "Web Search" tool (images, videos, deep research).
5.  **Firebase Configuration**:
    - `FIREBASE_ADMIN_KEY`: JSON service account key for backend auth verification.
6.  **MongoDB URI** (`MONGODB_URI`):
    - Used for: Persistent storage (chats, users).

---

## 6. How It Works (User Flow)

1.  **Initialization:**
    - `index.html` loads. `theme-init.js` sets colors. `components.js` fetches Sidebar/Topbar.
    - `canvas.js` initializes DOM elements but waits to load Monaco.
2.  **User Input:**
    - User types in `chat-input`.
    - If "Web Search" is active, frontend flags the request.
    - `chat.js` sends payload to Backend.
3.  **Backend Processing:**
    - Verifies Firebase Token.
    - **RAG:** Checks memory for context.
    - **Tools:** If "Web Search" requested, performs search + scraping.
    - Constructs a final prompt (System Prompt + Memory + Search Context + User Message).
    - Calls LLM (Gemini or Groq).
4.  **Response Streaming:**
    - Backend streams chunks to Frontend.
    - **Frontend Parser (`stream-handler.js`):**
      - Detects Markdown.
      - Detects Code Blocks (` ``` `).
      - If a code block is detected and **Canvas Mode** is active, it routes the text to `monacoEditor.setValue()` instead of the chat bubble.
5.  **Canvas Interaction:**
    - User sees code in Monaco.
    - User clicks "Preview" -> `updateCanvasPreview()` renders HTML in iframe.
    - User edits code -> Preview updates automatically.

---

## 7. Build & Setup Guide

Since the frontend is Vanilla JS, there is no "build" step (like Webpack/Vite) for the current version. The backend runs the show.

### Prerequisites

- Node.js (v18+)
- MongoDB (Local or Atlas)

### Installation

1.  **Clone Repository**

    ```bash
    git clone <repo_url>
    cd LYNQ
    ```

2.  **Install Backend Dependencies**

    ```bash
    npm install
    ```

3.  **Environment Setup**
    Create a `.env` file in the root directory:

    ```env
    MONGODB_URI=mongodb://localhost:27017/lynq
    GOOGLE_GENERATIVE_AI_KEY=your_gemini_key
    GROQ_API_KEY=your_groq_key
    OPENROUTER_API_KEY=your_openrouter_key  # Optional
    GOOGLE_SEARCH_API_KEY=your_search_api_key
    GOOGLE_SEARCH_ENGINE_ID=your_cse_id
    FIREBASE_ADMIN_KEY={"type": "service_account", ...} # Minified JSON string
    ```

4.  **Start Server**

    ```bash
    npm start
    # Server runs on port 3000
    ```

5.  **Access App**
    Open `http://localhost:3000` in your browser.
